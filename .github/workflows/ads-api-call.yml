name: Amazon Ads API (browser-only)

on:
  workflow_dispatch:
    inputs:
      region:
        description: "API 区域：na=北美, eu=欧洲, fe=远东(JP/SG/AU)"
        required: true
        default: "fe"
        type: choice
        options: [na, eu, fe]
      path:
        description: "API 路径（以 / 开头），如 /sp/campaigns?count=10 或 /sb/v4/campaigns/list"
        required: true
      method:
        description: "HTTP 方法"
        required: true
        default: "GET"
        type: choice
        options: [GET, POST, PUT, DELETE]
      scope:
        description: "Amazon-Advertising-API-Scope（profileId；/profiles、/status 可留空）"
        required: false
      body:
        description: "请求体 JSON（仅 POST/PUT 用；GET/DELETE 留空）"
        required: false
        default: ""
      extraAccept:
        description: "可选 Accept 头（如 SB v4：application/vnd.sbcampaignresource.v4+json）"
        required: false
        default: ""

jobs:
  call:
    runs-on: ubuntu-latest
    steps:
      - name: 校验 Secrets
        run: |
          test -n "${{ secrets.LWA_CLIENT_ID }}" || (echo "缺少 LWA_CLIENT_ID" && exit 1)
          test -n "${{ secrets.LWA_CLIENT_SECRET }}" || (echo "缺少 LWA_CLIENT_SECRET" && exit 1)
          test -n "${{ secrets.LWA_REFRESH_TOKEN }}" || (echo "缺少 LWA_REFRESH_TOKEN" && exit 1)

      - name: 刷新 access_token
        id: refresh
        run: |
          set -e
          ACCESS_JSON=$(curl -sS -X POST "https://api.amazon.com/auth/o2/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=refresh_token" \
            -d "refresh_token=${{ secrets.LWA_REFRESH_TOKEN }}" \
            -d "client_id=${{ secrets.LWA_CLIENT_ID }}" \
            -d "client_secret=${{ secrets.LWA_CLIENT_SECRET }}")

          # 取出 access_token
          ACCESS_TOKEN=$(echo "$ACCESS_JSON" | jq -r .access_token)
          if [ -z "$ACCESS_TOKEN" ] || [ "$ACCESS_TOKEN" = "null" ]; then
            echo "刷新失败：$ACCESS_JSON"
            exit 1
          fi
          echo "ACCESS_TOKEN=$ACCESS_TOKEN" >> $GITHUB_ENV

          # 安全地打印掩码（只显示前4后4位，确认非空）
          F=$(echo "$ACCESS_TOKEN" | cut -c1-4)
          L=$(echo "$ACCESS_TOKEN" | rev | cut -c1-4 | rev)
          echo "Access token 已获取：${F}****${L}"

      - name: 选择区域基址
        run: |
          case "${{ github.event.inputs.region }}" in
            na) echo "BASE=https://advertising-api.amazon.com" >> $GITHUB_ENV ;;
            eu) echo "BASE=https://advertising-api-eu.amazon.com" >> $GITHUB_ENV ;;
            fe) echo "BASE=https://advertising-api-fe.amazon.com" >> $GITHUB_ENV ;;
            *)  echo "BASE=https://advertising-api-fe.amazon.com" >> $GITHUB_ENV ;;
          esac

      - name: 调用 Amazon Ads API
        run: |
          set -e
          URL="${BASE}${{ github.event.inputs.path }}"
          echo "Request URL: $URL"
          echo "Method: ${{ github.event.inputs.method }}"

          # 基本请求头
          HDRS=(-H "Authorization: Bearer $ACCESS_TOKEN"
                -H "Amazon-Advertising-API-ClientId: ${{ secrets.LWA_CLIENT_ID }}"
                -H "Content-Type: application/json")

          # 可选 Scope（profileId）
          if [ -n "${{ github.event.inputs.scope }}" ]; then
            HDRS+=(-H "Amazon-Advertising-API-Scope: ${{ github.event.inputs.scope }}")
          fi

          # 可选 Accept（SB v4 常用）
          if [ -n "${{ github.event.inputs.extraAccept }}" ]; then
            HDRS+=(-H "Accept: ${{ github.event.inputs.extraAccept }}")
          fi

          # 请求体
          BODY='${{ github.event.inputs.body }}'
          if [ "${{ github.event.inputs.method }}" = "GET" ] || [ "${{ github.event.inputs.method }}" = "DELETE" ]; then
            # GET/DELETE 不发送 body
            curl -sS -D headers.txt -o body.json -X "${{ github.event.inputs.method }}" "${HDRS[@]}" "$URL"
          else
            if [ -z "$BODY" ]; then BODY='{}'; fi
            echo "$BODY" > body.json
            curl -sS -D headers.txt -o body.json -X "${{ github.event.inputs.method }}" "${HDRS[@]}" --data @body.json "$URL"
          fi

          echo "==== Response Headers ====" > result.txt
          cat headers.txt >> result.txt
          echo -e "\n==== Response Body ====\n" >> result.txt
          cat body.json | jq '.' >> result.txt 2>/dev/null || cat body.json >> result.txt

      - name: 上传结果（artifact）
        uses: actions/upload-artifact@v4
        with:
          name: ads-api-response
          path: |
            result.txt
            body.json
            headers.txt
