name: AMS Subscribe (Firehose)

on:
  workflow_dispatch:
    inputs:
      profileId:
        description: "Amazon-Advertising-API-Scope（例如 4269222081361224）"
        required: true
      datasetId:
        description: "数据集 ID（如 sp-traffic / sp-conversion / budget-usage）"
        required: true
        default: "sp-traffic"
      deliveryStreamArn:
        description: "Firehose Delivery Stream ARN（us-west-2）"
        required: true
      subscriberRoleArn:
        description: "Subscriber Role ARN（us-west-2）"
        required: true
      subscriptionRoleArn:
        description: "Subscription Role ARN（us-west-2）"
        required: true

jobs:
  subscribe:
    runs-on: ubuntu-latest
    steps:
      - name: Exchange refresh_token → access_token
        id: token
        shell: bash
        env:
          CLIENT_ID: ${{ secrets.LWA_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.LWA_CLIENT_SECRET }}
          REFRESH_TOKEN: ${{ secrets.LWA_REFRESH_TOKEN }}
        run: |
          set -euo pipefail
          OUT=$(mktemp); HDR=$(mktemp)
          # 注意：去掉了 -i，避免把响应头写进 body
          curl -sS -o "$OUT" -D "$HDR" https://api.amazon.com/auth/o2/token \
            -H "Content-Type: application/x-www-form-urlencoded" \
            --data-urlencode "grant_type=refresh_token" \
            --data-urlencode "refresh_token=$REFRESH_TOKEN" \
            --data-urlencode "client_id=$CLIENT_ID" \
            --data-urlencode "client_secret=$CLIENT_SECRET"
          echo "=== Token Response Headers ==="; head -n 1 "$HDR"; tail -n +2 "$HDR" | sed 's/^[[:space:]]\+//'
          echo "=== Token Response Body (JSON) ==="; cat "$OUT" | jq . || (echo "非 JSON 响应，前 200 字节：" && head -c 200 "$OUT")
          AT=$(cat "$OUT" | jq -r '.access_token // empty')
          if [ -z "$AT" ]; then
            echo "access_token 获取失败"; exit 1
          fi
          echo "access_token=$AT" >> "$GITHUB_OUTPUT"

      - name: Create subscription (dataset → Firehose, verbose)
        id: create
        shell: bash
        env:
          AT: ${{ steps.token.outputs.access_token }}
          SCOPE: ${{ github.event.inputs.profileId }}
          DATASET_ID: ${{ github.event.inputs.datasetId }}
          DELIVERY_ARN: ${{ github.event.inputs.deliveryStreamArn }}
          SUBSCRIBER_ARN: ${{ github.event.inputs.subscriberRoleArn }}
          SUBSCRIPTION_ARN: ${{ github.event.inputs.subscriptionRoleArn }}
          CLIENT_ID: ${{ secrets.LWA_CLIENT_ID }}
        run: |
          set -euo pipefail

          # 生成 clientRequestToken
          if command -v uuidgen >/dev/null 2>&1; then
            CRT=$(uuidgen)
          else
            CRT=$(cat /proc/sys/kernel/random/uuid)
          fi

          BODY=$(jq -n \
            --arg crt "$CRT" \
            --arg ds "$DATASET_ID" \
            --arg d "$DELIVERY_ARN" \
            --arg r1 "$SUBSCRIBER_ARN" \
            --arg r2 "$SUBSCRIPTION_ARN" \
            '{
              clientRequestToken: $crt,
              dataSetId: $ds,
              destination: {
                firehoseDestination: {
                  deliveryStreamArn: $d,
                  subscriberRoleArn: $r1,
                  subscriptionRoleArn: $r2
                }
              }
            }')

          echo "=== Create Request Body ==="
          echo "$BODY" | jq .

          CURL_OUT=$(mktemp)
          CURL_HDR=$(mktemp)
          # 同样：去掉 -i，只保留 -o 与 -D
          set +e
          curl -sS -o "$CURL_OUT" -D "$CURL_HDR" -X POST "https://advertising-api-fe.amazon.com/streams/subscriptions" \
            -H "Authorization: Bearer $AT" \
            -H "Amazon-Advertising-API-ClientId: $CLIENT_ID" \
            -H "Amazon-Advertising-API-Scope: $SCOPE" \
            -H "Accept: application/vnd.amazonmarketingstreamsubscriptions.v1+json" \
            -H "Content-Type: application/vnd.amazonmarketingstreamsubscriptions.v1+json" \
            --data "$BODY"
          RC=$?
          set -e

          echo "=== Create Response Headers ==="
          head -n 1 "$CURL_HDR"
          tail -n +2 "$CURL_HDR" | sed 's/^[[:space:]]\+//'
          echo "=== Create Response Body (JSON) ==="
          cat "$CURL_OUT" | jq . || (echo "非 JSON 响应，前 200 字节：" && head -c 200 "$CURL_OUT")

          SUB_ID=$(cat "$CURL_OUT" | jq -r '.subscriptionId // empty')
          if [ "$RC" -ne 0 ]; then
            echo "curl 返回码: $RC"; exit $RC
          fi
          if [ -z "$SUB_ID" ]; then
            echo "没有返回 subscriptionId，以上为完整响应。"; exit 1
          fi
          echo "subscription_id=$SUB_ID" >> "$GITHUB_OUTPUT"

      - name: Verify (list subscriptions)
        shell: bash
        env:
          RAW_AT: ${{ steps.token.outputs.access_token }}
          SCOPE: ${{ github.event.inputs.profileId }}
          CLIENT_ID: ${{ secrets.LWA_CLIENT_ID }}
        run: |
          set -euo pipefail
          echo "=== List Subscriptions ==="
          curl -sS -o - -X GET "https://advertising-api-fe.amazon.com/streams/subscriptions" \
            -H "Authorization: Bearer $RAW_AT" \
            -H "Amazon-Advertising-API-ClientId: $CLIENT_ID" \
            -H "Amazon-Advertising-API-Scope: $SCOPE" \
            -H "Accept: application/vnd.amazonmarketingstreamsubscriptions.v1+json" \
          | jq .
      - name: Debug GET profiles
        shell: bash
        env:
          AT: ${{ steps.token.outputs.access_token }}
          CLIENT_ID: ${{ secrets.LWA_CLIENT_ID }}
        run: |
          curl -sS -X GET "https://advertising-api-fe.amazon.com/v2/profiles" \
          -H "Authorization: Bearer $AT" \
          -H "Amazon-Advertising-API-ClientId: $CLIENT_ID" \
          -H "Accept: application/json" | jq .

