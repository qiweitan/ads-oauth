name: AMS Subscribe (Firehose)

on:
  workflow_dispatch:
    inputs:
      profileId:
        description: "Amazon-Advertising-API-Scope（例如 4269222081361224）"
        required: true
      datasetId:
        description: "数据集 ID（如 sp-traffic / sp-conversion / budget-usage）"
        required: true
        default: "sp-traffic"
      deliveryStreamArn:
        description: "Firehose Delivery Stream ARN（us-west-2）"
        required: true
      subscriberRoleArn:
        description: "Subscriber Role ARN（us-west-2）"
        required: true
      subscriptionRoleArn:
        description: "Subscription Role ARN（us-west-2）"
        required: true

jobs:
  subscribe:
    runs-on: ubuntu-latest
    steps:
      - name: Exchange refresh_token → access_token
        id: token
        shell: bash
        env:
          CLIENT_ID: ${{ secrets.LWA_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.LWA_CLIENT_SECRET }}
          REFRESH_TOKEN: ${{ secrets.LWA_REFRESH_TOKEN }}
        run: |
          set -euo pipefail
          OUT=$(mktemp); HDR=$(mktemp)
          curl -sS -i -o "$OUT" -D "$HDR" https://api.amazon.com/auth/o2/token \
            -H "Content-Type: application/x-www-form-urlencoded" \
            --data-urlencode "grant_type=refresh_token" \
            --data-urlencode "refresh_token=$REFRESH_TOKEN" \
            --data-urlencode "client_id=$CLIENT_ID" \
            --data-urlencode "client_secret=$CLIENT_SECRET"
          echo "=== Token Response Headers ==="
          cat "$HDR"
          echo "=== Token Response Body ==="
          cat "$OUT" | jq . || cat "$OUT"
          AT=$(cat "$OUT" | jq -r '.access_token // empty')
          if [ -z "$AT" ]; then
            echo "access_token 获取失败"; exit 1
          fi
          echo "access_token=$AT" >> "$GITHUB_OUTPUT"

      - name: Create subscription (dataset → Firehose, verbose)
        id: create
        shell: bash
        env:
          AT: ${{ steps.token.outputs.access_token }}
          SCOPE: ${{ github.event.inputs.profileId }}
          DATASET_ID: ${{ github.event.inputs.datasetId }}
          DELIVERY_ARN: ${{ github.event.inputs.deliveryStreamArn }}
          SUBSCRIBER_ARN: ${{ github.event.inputs.subscriberRoleArn }}
          SUBSCRIPTION_ARN: ${{ github.event.inputs.subscriptionRoleArn }}
          CLIENT_ID: ${{ secrets.LWA_CLIENT_ID }}
        run: |
          set -euo pipefail

          # 1) 生成 clientRequestToken
          if command -v uuidgen >/dev/null 2>&1; then
            CRT=$(uuidgen)
          else
            CRT=$(cat /proc/sys/kernel/random/uuid)
          fi

          # 2) 用 jq 组装请求体，避免手写 JSON 转义
          BODY=$(jq -n \
            --arg crt "$CRT" \
            --arg ds "$DATASET_ID" \
            --arg d "$DELIVERY_ARN" \
            --arg r1 "$SUBSCRIBER_ARN" \
            --arg r2 "$SUBSCRIPTION_ARN" \
            '{
              clientRequestToken: $crt,
              dataSetId: $ds,
              destination: {
                firehoseDestination: {
                  deliveryStreamArn: $d,
                  subscriberRoleArn: $r1,
                  subscriptionRoleArn: $r2
                }
              }
            }')

          echo "=== Request body ==="
          echo "$BODY" | jq .

          # 3) 发送创建订阅请求（保留头和返回体）
          RESP_BODY=$(mktemp)
          RESP_HDR=$(mktemp)

          set +e
          curl -sS -i -o "$RESP_BODY" -D "$RESP_HDR" \
            -X POST "https://advertising-api.amazon.com/streams/subscriptions" \
            -H "Authorization: Bearer $AT" \
            -H "Amazon-Advertising-API-ClientId: $CLIENT_ID" \
            -H "Amazon-Advertising-API-Scope: $SCOPE" \
            -H "Accept: application/vnd.amazonmarketingstreamsubscriptions.v1+json" \
            -H "Content-Type: application/vnd.amazonmarketingstreamsubscriptions.v1+json" \
            --data "$BODY"
          RC=$?
          set -e

          echo "=== Response headers ==="
          cat "$RESP_HDR"
          echo "=== Response body ==="
          cat "$RESP_BODY" | jq . || cat "$RESP_BODY"

          SUB_ID=$(cat "$RESP_BODY" | jq -r '.subscriptionId // empty')

          if [ "$RC" -ne 0 ]; then
            echo "curl 返回码: $RC"
            exit $RC
          fi

          if [ -z "$SUB_ID" ]; then
            echo "没有返回 subscriptionId，见上面的响应内容。"
            exit 1
          fi

          echo "subscription_id=$SUB_ID" >> "$GITHUB_OUTPUT"

      - name: Verify (list subscriptions)
        shell: bash
        env:
          RAW_AT: ${{ steps.token.outputs.access_token }}
          SCOPE: ${{ github.event.inputs.profileId }}
          CLIENT_ID: ${{ secrets.LWA_CLIENT_ID }}
        run: |
          set -euo pipefail
          echo "=== List subscriptions ==="
          curl -sS -X GET "https://advertising-api.amazon.com/streams/subscriptions" \
            -H "Authorization: Bearer $RAW_AT" \
            -H "Amazon-Advertising-API-ClientId: $CLIENT_ID" \
            -H "Amazon-Advertising-API-Scope: $SCOPE" \
            -H "Accept: application/vnd.amazonmarketingstreamsubscriptions.v1+json" \
          | jq .
